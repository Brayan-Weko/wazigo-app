{% extends "base.html" %}

{% block title %}Résultats - {{ app_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header avec recherche -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-16 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <!-- Search summary -->
                <div class="flex-1">
                    <h1 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                        Itinéraires trouvés
                    </h1>
                    <div class="text-sm text-gray-600 dark:text-gray-300" id="search-summary">
                        <span id="origin-display">{{ search_data.origin }}</span>
                        <i class="fas fa-arrow-right mx-2"></i>
                        <span id="destination-display">{{ search_data.destination }}</span>
                    </div>
                </div>
                
                <!-- Quick actions -->
                <div class="flex items-center space-x-2">
                    <button onclick="modifySearch()" 
                            class="btn-secondary">
                        <i class="fas fa-edit mr-2"></i>
                        Modifier
                    </button>
                    <button onclick="refreshResults()" 
                            id="refresh-btn"
                            class="btn-outline">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Routes list -->
            <div class="lg:col-span-1 space-y-4">
                <!-- Loading state -->
                <div id="routes-loading" class="space-y-4">
                    {% for i in range(3) %}
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="animate-pulse">
                            <div class="flex justify-between items-start mb-4">
                                <div class="space-y-2">
                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-24"></div>
                                    <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-16"></div>
                                </div>
                                <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-12"></div>
                            </div>
                            <div class="space-y-2">
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-full"></div>
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Routes container -->
                <div id="routes-container" class="space-y-4 hidden">
                    <!-- Routes will be populated by JavaScript -->
                </div>

                <!-- No results -->
                <div id="no-results" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-lg">
                        <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                            Aucun itinéraire trouvé
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">
                            Vérifiez vos adresses ou essayez d'autres options.
                        </p>
                        <button onclick="modifySearch()" class="btn-primary">
                            <i class="fas fa-edit mr-2"></i>
                            Modifier la recherche
                        </button>
                    </div>
                </div>

                <!-- Error state -->
                <div id="error-state" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-lg">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                            Erreur de calcul
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4" id="error-message">
                            Une erreur s'est produite lors du calcul des itinéraires.
                        </p>
                        <button onclick="refreshResults()" class="btn-primary">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Réessayer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                                <i class="fas fa-map text-primary-600 mr-2"></i>
                                Carte interactive
                            </h2>
                            <div class="flex items-center space-x-2">
                                <!-- Map controls -->
                                <button onclick="toggleTrafficLayer()" 
                                        id="traffic-toggle"
                                        class="btn-secondary text-sm">
                                    <i class="fas fa-road mr-1"></i>
                                    Trafic
                                </button>
                                <button onclick="centerMap()" 
                                        class="btn-secondary text-sm">
                                    <i class="fas fa-crosshairs mr-1"></i>
                                    Centrer
                                </button>
                                <button onclick="toggleFullscreen()" 
                                        class="btn-secondary text-sm">
                                    <i class="fas fa-expand mr-1"></i>
                                    Plein écran
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Map container -->
                    <div id="map-container" class="map-container h-96 lg:h-[600px] relative">
                        <div class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-600 dark:text-gray-300">Chargement de la carte...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route details modal -->
        <div id="route-details-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                            Détails de l'itinéraire
                        </h3>
                        <button onclick="closeRouteDetails()" 
                                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div id="route-details-content">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/maps.js') }}"></script>
<script>
    // Initialize results page
    document.addEventListener('DOMContentLoaded', function() {
        initializeResultsPage();
    });

    let currentRoutes = [];
    let selectedRouteIndex = 0;
    let map = null;
    let searchResultsData = null;

    function initializeResultsPage() {
        try {
            const storedResults = sessionStorage.getItem('searchResults');
            console.log('Données sessionStorage:', storedResults);
            
            if (!storedResults) {
                console.error('Aucune donnée de recherche dans sessionStorage');
                showError('Aucune donnée de recherche trouvée');
                redirectToSearch();
                return;
            }

            searchResultsData = JSON.parse(storedResults);
            console.log('Données parsées:', searchResultsData);

            // Vérifier la structure des données
            if (!searchResultsData.success) {
                console.error('Recherche échouée:', searchResultsData.error);
                showError(searchResultsData.error?.message || 'Erreur de recherche');
                redirectToSearch();
                return;
            }

            if (!searchResultsData.routes || searchResultsData.routes.length === 0) {
                console.error('Aucune route trouvée');
                showNoResults();
                return;
            }

            // ✅ Extraire les paramètres de recherche depuis les données
            const firstRoute = searchResultsData.routes[0];
            const searchParams = {
                origin: firstRoute.origin_coords?.address || 'Point de départ',
                destination: firstRoute.destination_coords?.address || 'Point d\'arrivée'
            };

            console.log('Paramètres extraits:', searchParams);

            // Mettre à jour l'affichage
            document.getElementById('origin-display').textContent = searchParams.origin;
            document.getElementById('destination-display').textContent = searchParams.destination;

            // Afficher les routes
            currentRoutes = searchResultsData.routes;
            hideLoading();
            displayRoutes(currentRoutes);
            
            // Initialiser la carte
            initializeMap();
            displayRoutesOnMap(currentRoutes);
            selectRoute(0); // Sélectionner la première route par défaut

        } catch (error) {
            console.error('Erreur lors de l\'initialisation:', error);
            showError('Erreur lors du chargement des résultats');
            redirectToSearch();
        }
    }

    function redirectToSearch() {
        // Rediriger vers la page de recherche après 2 secondes
        setTimeout(() => {
            window.location.href = '{{ url_for("main.search") }}';
        }, 2000);
    }

    async function searchRoutes(searchParams) {
        try {
            showLoading();
            
            const response = await apiRequest('/api/search-routes', {
                method: 'POST',
                body: JSON.stringify(searchParams)
            });

            hideLoading();

            if (response.success && response.routes && response.routes.length > 0) {
                currentRoutes = response.routes;
                displayRoutes(currentRoutes);
                displayRoutesOnMap(currentRoutes);
                selectRoute(0); // Select first route by default
            } else {
                showNoResults();
            }

        } catch (error) {
            hideLoading();
            showError(error.message || 'Erreur lors du calcul des itinéraires');
        }
    }

    function displayRoutes(routes) {
        const container = document.getElementById('routes-container');
        const loadingElement = document.getElementById('routes-loading');
        
        loadingElement.classList.add('hidden');
        container.classList.remove('hidden');
        container.innerHTML = '';

        console.log('Affichage de', routes.length, 'routes');

        routes.forEach((route, index) => {
            const routeElement = createRouteCard(route, index);
            container.appendChild(routeElement);
        });
    }

    function createRouteCard(route, index) {
        const card = document.createElement('div');
        card.className = `route-card bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg cursor-pointer transition-all duration-200 hover:shadow-xl ${index === selectedRouteIndex ? 'selected ring-2 ring-primary-500' : ''}`;
        card.onclick = () => selectRoute(index);

        // ✅ CORRECTION: Gérer les différents formats de données de route
        let summary, score, recommendation;
        
        if (route.summary) {
            summary = route.summary;
        } else if (route.original_data && route.original_data.summary) {
            summary = route.original_data.summary;
        } else {
            // Format par défaut si les données sont manquantes
            summary = {
                duration: route.duration || route.travel_time_seconds || 0,
                length: route.length || route.distance_meters || 0
            };
        }

        score = route.optimization_score || 0;
        recommendation = route.recommendation;

        card.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getScoreClass(score)}">
                            ${formatScore(score)}
                        </span>
                        ${recommendation ? `
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                ${recommendation.title || 'Recommandé'}
                            </span>
                        ` : ''}
                    </div>
                    <div class="text-lg font-semibold text-gray-900 dark:text-white">
                        ${formatDuration(summary.duration)}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-300">
                        ${formatDistance(summary.length)}
                        ${summary.delay_info && summary.delay_info.delay_seconds > 0 ? 
                            `<span class="text-orange-600 dark:text-orange-400 ml-2">
                                +${formatDuration(summary.delay_info.delay_seconds)}
                            </span>` : ''
                        }
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <button onclick="event.stopPropagation(); startNavigation(${index})" 
                            class="btn-primary text-sm mb-2">
                        <i class="fas fa-play mr-1"></i>
                        Partir
                    </button>
                    <button onclick="event.stopPropagation(); showRouteDetails(${index})" 
                            class="text-gray-400 hover:text-primary-600 transition-colors">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Traffic info -->
            ${route.traffic_analysis ? `
                <div class="flex items-center mb-3">
                    <div class="w-3 h-3 rounded-full ${getTrafficClass(route.traffic_analysis.status || route.traffic_analysis.level)} mr-2"></div>
                    <span class="text-sm text-gray-600 dark:text-gray-300">
                        ${getTrafficDescription(route.traffic_analysis)}
                    </span>
                </div>
            ` : ''}

            <!-- Route info -->
            <div class="grid grid-cols-2 gap-4 text-xs text-gray-500 dark:text-gray-400 pt-3 border-t border-gray-200 dark:border-gray-700">
                <div>
                    <i class="fas fa-route mr-1"></i>
                    Route ${index + 1}
                </div>
                <div>
                    <i class="fas fa-star mr-1"></i>
                    Score: ${formatScore(score)}
                </div>
            </div>
        `;

        return card;
    }

    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return 'N/A';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (hours > 0) {
            return `${hours}h ${minutes}min`;
        } else {
            return `${minutes}min`;
        }
    }

    function formatDistance(meters) {
        if (!meters || isNaN(meters)) return 'N/A';
        
        if (meters < 1000) {
            return `${Math.round(meters)}m`;
        } else {
            return `${(meters / 1000).toFixed(1)}km`;
        }
    }

    function formatScore(score) {
        if (!score || isNaN(score)) return 'N/A';
        return `${score.toFixed(1)}/10`;
    }

    function getScoreClass(score) {
        if (!score || isNaN(score)) return 'bg-gray-100 text-gray-800';
        
        if (score >= 8.5) return 'bg-green-100 text-green-800';
        if (score >= 7.0) return 'bg-blue-100 text-blue-800';
        if (score >= 5.5) return 'bg-yellow-100 text-yellow-800';
        if (score >= 3.0) return 'bg-orange-100 text-orange-800';
        return 'bg-red-100 text-red-800';
    }

    function getTrafficClass(status) {
        switch(status?.toLowerCase()) {
            case 'free': return 'bg-green-500';
            case 'light': return 'bg-yellow-500';
            case 'moderate': return 'bg-orange-500';
            case 'heavy': return 'bg-red-500';
            default: return 'bg-gray-500';
        }
    }

    function getTrafficDescription(trafficAnalysis) {
        if (!trafficAnalysis) return 'Trafic inconnu';
        
        const status = trafficAnalysis.status || trafficAnalysis.level || 'unknown';
        const descriptions = {
            'free': 'Circulation fluide',
            'light': 'Trafic léger',
            'moderate': 'Trafic modéré',
            'heavy': 'Trafic dense',
            'unknown': 'Trafic inconnu'
        };
        
        return descriptions[status.toLowerCase()] || 'Trafic inconnu';
    }

    function selectRoute(index) {
        selectedRouteIndex = index;
        
        // Update UI
        document.querySelectorAll('.route-card').forEach((card, i) => {
            card.classList.toggle('selected', i === index);
            if (i === index) {
                card.classList.add('ring-2', 'ring-primary-500');
            } else {
                card.classList.remove('ring-2', 'ring-primary-500');
            }
        });

        // Update map if available
        if (map && currentRoutes[index]) {
            highlightRouteOnMap(currentRoutes[index], index);
        }

        console.log('Route sélectionnée:', index, currentRoutes[index]);
    }

    function startNavigation(routeIndex) {
        const route = currentRoutes[routeIndex];
        if (!route) return;

        // Sauvegarder la route sélectionnée
        sessionStorage.setItem('selectedRoute', JSON.stringify(route));
        
        showAlert('🚀 Navigation démarrée !', 'success');

        // Save route to history and start navigation
        const params = new URLSearchParams({
            route_id: route.id || `temp_${Date.now()}`
        });

        window.location.href = `{{ url_for('main.navigation') }}?${params.toString()}`;
    }

    function showRouteDetails(routeIndex) {
        const route = currentRoutes[routeIndex];
        if (!route) return;

        const modal = document.getElementById('route-details-modal');
        const content = document.getElementById('route-details-content');

        content.innerHTML = generateRouteDetailsHTML(route);
        modal.classList.remove('hidden');
    }

    function closeRouteDetails() {
        document.getElementById('route-details-modal').classList.add('hidden');
    }

    /*
    function generateRouteDetailsHTML(route) {
        const summary = route.summary;
        
        return `
            <div class="space-y-6">
                <!-- Overview -->
                <div>
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Aperçu</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Durée</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatDuration(summary.duration)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Distance</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatDistance(summary.length)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Score</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatScore(route.optimization_score)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Coût estimé</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${route.cost_estimate ? route.cost_estimate.total_cost + '€' : 'N/A'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Traffic Analysis -->
                ${route.traffic_analysis ? `
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Analyse du trafic</h4>
                        <div class="flex items-center mb-2">
                            <div class="w-4 h-4 rounded-full ${getTrafficClass(route.traffic_analysis.level)} mr-3"></div>
                            <span class="font-medium text-gray-900 dark:text-white">
                                ${route.traffic_analysis.description}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            Fluidité : ${route.traffic_analysis.ratio.toFixed(1)}x le temps normal
                        </p>
                    </div>
                ` : ''}

                <!-- Environmental Impact -->
                ${route.environmental_impact ? `
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Impact environnemental</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Consommation estimée</span>
                                <span class="font-medium">${route.environmental_impact.estimated_fuel_consumption.toFixed(1)}L</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Émissions CO₂</span>
                                <span class="font-medium">${route.environmental_impact.estimated_co2_emission.toFixed(1)}kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Score environnemental</span>
                                <span class="font-medium">${route.environmental_impact.environmental_score}/10</span>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Actions -->
                <div class="flex space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="startNavigation(${selectedRouteIndex})" class="btn-primary flex-1">
                        <i class="fas fa-play mr-2"></i>
                        Démarrer la navigation
                    </button>
                    <button onclick="saveRoute(${selectedRouteIndex})" class="btn-secondary">
                        <i class="fas fa-star mr-2"></i>
                        Sauvegarder
                    </button>
                    <button onclick="shareRoute(currentRoutes[${selectedRouteIndex}])" class="btn-secondary">
                        <i class="fas fa-share mr-2"></i>
                        Partager
                    </button>
                </div>
            </div>
        `;
    }
    */

    function generateRouteDetailsHTML(route) {
        const summary = route.summary || route.original_data?.summary || {};
        
        return `
            <div class="space-y-6">
                <!-- Overview -->
                <div>
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Aperçu</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Durée</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatDuration(summary.duration)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Distance</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatDistance(summary.length)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Score</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatScore(route.optimization_score)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Statut trafic</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${getTrafficDescription(route.traffic_analysis)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="startNavigation(${selectedRouteIndex})" class="btn-primary flex-1">
                        <i class="fas fa-play mr-2"></i>
                        Démarrer la navigation
                    </button>
                    <button onclick="saveRoute(${selectedRouteIndex})" class="btn-secondary">
                        <i class="fas fa-star mr-2"></i>
                        Sauvegarder
                    </button>
                </div>
            </div>
        `;
    }

    function modifySearch() {
        // Retourner à la page de recherche
        window.location.href = '{{ url_for("main.search") }}';
    }

    function refreshResults() {
        const refreshBtn = document.getElementById('refresh-btn');
        const originalContent = refreshBtn.innerHTML;
        
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Actualisation...';
        refreshBtn.disabled = true;

        // Rafraîchir les données
        setTimeout(() => {
            refreshBtn.innerHTML = originalContent;
            refreshBtn.disabled = false;
            showAlert('Résultats actualisés', 'success');
        }, 1000);
    }

    function showLoading() {
        document.getElementById('routes-loading').classList.remove('hidden');
        document.getElementById('routes-container').classList.add('hidden');
        document.getElementById('no-results').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
    }

    function hideLoading() {
        document.getElementById('routes-loading').classList.add('hidden');
    }

    function showNoResults() {
        hideLoading();
        document.getElementById('no-results').classList.remove('hidden');
    }

    function showError(message) {
        hideLoading();
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-state').classList.remove('hidden');
    }

    async function saveRoute(routeIndex) {
        // Vérifier si l'utilisateur est connecté
        const userElement = document.querySelector('[data-user-authenticated]');
        const isAuthenticated = userElement?.dataset.userAuthenticated === 'true';
        
        if (!isAuthenticated) {
            showAlert('Veuillez vous connecter pour sauvegarder des itinéraires', 'warning');
            return;
        }

        const route = currentRoutes[routeIndex];
        const routeName = prompt('Nom de l\'itinéraire :', 
            `Route ${routeIndex + 1} - ${formatDuration(route.summary?.duration || 0)}`);
        
        if (!routeName) return;

        try {
            const originCoords = route.origin_coords || {};
            const destCoords = route.destination_coords || {};
            
            const response = await fetch('/api/saved-routes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: routeName,
                    origin_address: originCoords.address || 'Point de départ',
                    origin_lat: originCoords.lat || 0,
                    origin_lng: originCoords.lng || 0,
                    destination_address: destCoords.address || 'Point d\'arrivée',
                    destination_lat: destCoords.lat || 0,
                    destination_lng: destCoords.lng || 0
                })
            });

            const data = await response.json();
            if (data.success) {
                showAlert('Itinéraire sauvegardé avec succès', 'success');
            } else {
                showAlert('Erreur lors de la sauvegarde', 'error');
            }
        } catch (error) {
            console.error('Save error:', error);
            showAlert('Erreur lors de la sauvegarde', 'error');
        }
    }

    // Map functions (to be implemented in maps.js)
    function initializeMap() {
        // Implementation in maps.js
    }
</script>
{% endblock %}