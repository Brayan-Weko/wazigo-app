{% extends "base.html" %}

{% block title %}R√©sultats - {{ app_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header avec recherche -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-16 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <!-- Search summary -->
                <div class="flex-1">
                    <h1 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                        Itin√©raires trouv√©s
                    </h1>
                    <div class="text-sm text-gray-600 dark:text-gray-300" id="search-summary">
                        <span id="origin-display">{{ search_data.origin }}</span>
                        <i class="fas fa-arrow-right mx-2"></i>
                        <span id="destination-display">{{ search_data.destination }}</span>
                    </div>
                </div>
                
                <!-- Quick actions -->
                <div class="flex items-center space-x-2">
                    <button onclick="modifySearch()" 
                            class="btn-secondary">
                        <i class="fas fa-edit mr-2"></i>
                        Modifier
                    </button>
                    <button onclick="refreshResults()" 
                            id="refresh-btn"
                            class="btn-outline">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualiser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Routes list -->
            <div class="lg:col-span-1 space-y-4">
                <!-- Loading state -->
                <div id="routes-loading" class="space-y-4">
                    {% for i in range(3) %}
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="animate-pulse">
                            <div class="flex justify-between items-start mb-4">
                                <div class="space-y-2">
                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-24"></div>
                                    <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-16"></div>
                                </div>
                                <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-12"></div>
                            </div>
                            <div class="space-y-2">
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-full"></div>
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Routes container -->
                <div id="routes-container" class="space-y-4 hidden">
                    <!-- Routes will be populated by JavaScript -->
                </div>

                <!-- No results -->
                <div id="no-results" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-lg">
                        <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                            Aucun itin√©raire trouv√©
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">
                            V√©rifiez vos adresses ou essayez d'autres options.
                        </p>
                        <button onclick="modifySearch()" class="btn-primary">
                            <i class="fas fa-edit mr-2"></i>
                            Modifier la recherche
                        </button>
                    </div>
                </div>

                <!-- Error state -->
                <div id="error-state" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-lg">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                            Erreur de calcul
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4" id="error-message">
                            Une erreur s'est produite lors du calcul des itin√©raires.
                        </p>
                        <button onclick="refreshResults()" class="btn-primary">
                            <i class="fas fa-sync-alt mr-2"></i>
                            R√©essayer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                                <i class="fas fa-map text-primary-600 mr-2"></i>
                                Carte interactive
                            </h2>
                            <div class="flex items-center space-x-2">
                                <!-- Map controls -->
                                <button onclick="toggleTrafficLayer()" 
                                        id="traffic-toggle"
                                        class="btn-secondary text-sm">
                                    <i class="fas fa-road mr-1"></i>
                                    Trafic
                                </button>
                                <button onclick="centerMap()" 
                                        class="btn-secondary text-sm">
                                    <i class="fas fa-crosshairs mr-1"></i>
                                    Centrer
                                </button>
                                <button onclick="toggleFullscreen()" 
                                        class="btn-secondary text-sm">
                                    <i class="fas fa-expand mr-1"></i>
                                    Plein √©cran
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Map container -->
                    <div id="map-container" class="map-container h-96 lg:h-[600px] relative">
                        <div class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-600 dark:text-gray-300">Chargement de la carte...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route details modal -->
        <div id="route-details-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                            D√©tails de l'itin√©raire
                        </h3>
                        <button onclick="closeRouteDetails()" 
                                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div id="route-details-content">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/maps.js') }}"></script>
<script>
    // Initialize results page
    document.addEventListener('DOMContentLoaded', function() {
        initializeResultsPage();
    });

    let currentRoutes = [];
    let selectedRouteIndex = 0;
    let map = null;
    let searchResultsData = null;

    function initializeResultsPage() {
        // ‚úÖ R√©cup√©rer les donn√©es depuis sessionStorage
        try {
            const storedResults = sessionStorage.getItem('searchResults');
            console.log('Donn√©es sessionStorage:', storedResults);
            
            if (!storedResults) {
                console.error('Aucune donn√©e de recherche dans sessionStorage');
                showError('Aucune donn√©e de recherche trouv√©e');
                redirectToSearch();
                return;
            }

            searchResultsData = JSON.parse(storedResults);
            console.log('Donn√©es pars√©es:', searchResultsData);

            // V√©rifier la structure des donn√©es
            if (!searchResultsData.success) {
                console.error('Recherche √©chou√©e:', searchResultsData.error);
                showError(searchResultsData.error?.message || 'Erreur de recherche');
                redirectToSearch();
                return;
            }

            if (!searchResultsData.routes || searchResultsData.routes.length === 0) {
                console.error('Aucune route trouv√©e');
                showNoResults();
                return;
            }

            // ‚úÖ Extraire les param√®tres de recherche depuis les donn√©es
            const firstRoute = searchResultsData.routes[0];
            const searchParams = {
                origin: firstRoute.origin_coords?.address || 'Point de d√©part',
                destination: firstRoute.destination_coords?.address || 'Point d\'arriv√©e'
            };

            console.log('Param√®tres extraits:', searchParams);

            // Mettre √† jour l'affichage
            document.getElementById('origin-display').textContent = searchParams.origin;
            document.getElementById('destination-display').textContent = searchParams.destination;

            // Afficher les routes
            currentRoutes = searchResultsData.routes;
            hideLoading();
            displayRoutes(currentRoutes);
            
            // ‚úÖ Initialiser la carte HERE Maps
            initializeHereMap();

        } catch (error) {
            console.error('Erreur lors de l\'initialisation:', error);
            showError('Erreur lors du chargement des r√©sultats');
            redirectToSearch();
        }
    }
    
    function redirectToSearch() {
        setTimeout(() => {
            window.location.href = '{{ url_for("main.search") }}';
        }, 2000);
    }
    
    async function initializeHereMap() {
        try {
            // Attendre que MapManager soit disponible
            if (!window.MapManager) {
                console.error('MapManager not available');
                showMapError();
                return;
            }

            mapManager = window.MapManager;

            // Calculer le centre de la carte bas√© sur les routes
            const mapCenter = calculateMapCenter(currentRoutes);
            
            // Initialiser la carte
            await mapManager.initializeMap('map-container', {
                zoom: 12,
                center: mapCenter
            });

            // Pr√©parer et afficher les routes
            const preparedRoutes = prepareRoutesForHereMap(currentRoutes);
            if (preparedRoutes.length > 0) {
                displayRoutesOnMap(preparedRoutes);
                selectRoute(0); // S√©lectionner la premi√®re route
            }

            // √âcouter les √©v√©nements de s√©lection de route depuis la carte
            window.addEventListener('routeSelected', (event) => {
                selectRoute(event.detail.routeIndex);
            });

        } catch (error) {
            console.error('Erreur initialisation carte HERE:', error);
            showMapError();
        }
    }

    function calculateMapCenter(routes) {
        if (!routes || routes.length === 0) {
            return { lat: 3.8480, lng: 11.5021 }; // Paris par d√©faut
        }

        const firstRoute = routes[0];
        if (firstRoute.origin_coords && firstRoute.destination_coords) {
            const originLat = parseFloat(firstRoute.origin_coords.lat) || 0;
            const originLng = parseFloat(firstRoute.origin_coords.lng) || 0;
            const destLat = parseFloat(firstRoute.destination_coords.lat) || 0;
            const destLng = parseFloat(firstRoute.destination_coords.lng) || 0;

            return {
                lat: (originLat + destLat) / 2,
                lng: (originLng + destLng) / 2
            };
        }

        return { lat: 48.8566, lng: 2.3522 };
    }

    function prepareRoutesForHereMap(routes) {
        return routes.map((route, index) => {
            const preparedRoute = {
                id: route.id || `route_${index}`,
                coordinates: [],
                summary: {
                    origin: null,
                    destination: null
                },
                ...route
            };

            // ‚úÖ Extraire les coordonn√©es depuis polyline HERE Maps
            if (route.sections && route.sections[0] && route.sections[0].polyline) {
                preparedRoute.coordinates = decodeHerePolyline(route.sections[0].polyline);
            } else if (route.polyline) {
                preparedRoute.coordinates = decodeHerePolyline(route.polyline);
            } else if (route.original_data && route.original_data.sections) {
                // Fallback : essayer dans original_data
                const section = route.original_data.sections[0];
                if (section && section.polyline) {
                    preparedRoute.coordinates = decodeHerePolyline(section.polyline);
                }
            }

            // Si pas de polyline, cr√©er une ligne droite simple
            if (preparedRoute.coordinates.length === 0) {
                if (route.origin_coords && route.destination_coords) {
                    preparedRoute.coordinates = [
                        { lat: route.origin_coords.lat, lng: route.origin_coords.lng },
                        { lat: route.destination_coords.lat, lng: route.destination_coords.lng }
                    ];
                }
            }

            // D√©finir origine et destination
            if (route.origin_coords) {
                preparedRoute.summary.origin = {
                    lat: parseFloat(route.origin_coords.lat),
                    lng: parseFloat(route.origin_coords.lng)
                };
            }

            if (route.destination_coords) {
                preparedRoute.summary.destination = {
                    lat: parseFloat(route.destination_coords.lat),
                    lng: parseFloat(route.destination_coords.lng)
                };
            }

            return preparedRoute;
        });
    }

    function decodeHerePolyline(polylineString) {
        // ‚úÖ D√©codage de polyline HERE Maps (format flexible polyline)
        if (!polylineString) return [];

        try {
            // HERE Maps utilise un format d'encodage sp√©cifique
            // Ici on fait une impl√©mentation simplifi√©e
            // Dans un vrai projet, utilisez la librairie HERE flexible-polyline
            
            // Pour l'instant, retourner un tableau vide et laisser MapManager g√©rer
            console.warn('Polyline decoding not fully implemented, using fallback');
            return [];
        } catch (error) {
            console.error('Erreur d√©codage polyline:', error);
            return [];
        }
    }

    function displayRoutes(routes) {
        const container = document.getElementById('routes-container');
        const loadingElement = document.getElementById('routes-loading');
        
        loadingElement.classList.add('hidden');
        container.classList.remove('hidden');
        container.innerHTML = '';

        console.log('Affichage de', routes.length, 'routes');

        routes.forEach((route, index) => {
            const routeElement = createRouteCard(route, index);
            container.appendChild(routeElement);
        });
    }

    function createRouteCard(route, index) {
        const card = document.createElement('div');
        card.className = `route-card bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg cursor-pointer transition-all duration-200 hover:shadow-xl ${index === selectedRouteIndex ? 'selected ring-2 ring-primary-500' : ''}`;
        card.onclick = () => selectRoute(index);

        // ‚úÖ G√©rer les diff√©rents formats de donn√©es de route
        let summary, score, recommendation;
        
        if (route.summary) {
            summary = route.summary;
        } else if (route.original_data && route.original_data.summary) {
            summary = route.original_data.summary;
        } else {
            summary = {
                duration: route.duration || route.travel_time_seconds || 0,
                length: route.length || route.distance_meters || 0
            };
        }

        score = route.optimization_score || 0;
        recommendation = route.recommendation;

        card.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getScoreClass(score)}">
                            ${formatScore(score)}
                        </span>
                        ${recommendation ? `
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                ${recommendation.title || 'Recommand√©'}
                            </span>
                        ` : ''}
                        ${index === 0 ? `
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                <i class="fas fa-star mr-1"></i> Optimal
                            </span>
                        ` : ''}
                    </div>
                    <div class="text-lg font-semibold text-gray-900 dark:text-white">
                        ${formatDuration(summary.duration)}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-300">
                        ${formatDistance(summary.length)}
                        ${summary.delay_info && summary.delay_info.delay_seconds > 0 ? 
                            `<span class="text-orange-600 dark:text-orange-400 ml-2">
                                +${formatDuration(summary.delay_info.delay_seconds)}
                            </span>` : ''
                        }
                    </div>
                </div>
                <div class="flex flex-col items-end space-y-2">
                    <button onclick="event.stopPropagation(); startNavigation(${index})" 
                            class="btn-primary text-sm">
                        <i class="fas fa-play mr-1"></i>
                        Partir
                    </button>
                    <button onclick="event.stopPropagation(); showRouteDetails(${index})" 
                            class="text-gray-400 hover:text-primary-600 transition-colors">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Traffic info -->
            ${route.traffic_analysis ? `
                <div class="flex items-center mb-3">
                    <div class="w-3 h-3 rounded-full ${getTrafficClass(route.traffic_analysis.status || route.traffic_analysis.level)} mr-2"></div>
                    <span class="text-sm text-gray-600 dark:text-gray-300">
                        ${getTrafficDescription(route.traffic_analysis)}
                    </span>
                </div>
            ` : ''}

            <!-- Route info -->
            <div class="grid grid-cols-3 gap-4 text-xs text-gray-500 dark:text-gray-400 pt-3 border-t border-gray-200 dark:border-gray-700">
                <div>
                    <i class="fas fa-route mr-1"></i>
                    Route ${index + 1}
                </div>
                <div>
                    <i class="fas fa-star mr-1"></i>
                    Score: ${formatScore(score)}
                </div>
                <div>
                    <i class="fas fa-clock mr-1"></i>
                    ${getRouteTypeLabel(route)}
                </div>
            </div>
        `;

        return card;
    }

    function getRouteTypeLabel(route) {
        if (route.route_type) {
            const types = {
                'fastest': 'Rapide',
                'shortest': 'Court',
                'balanced': '√âquilibr√©'
            };
            return types[route.route_type] || 'Standard';
        }
        return 'Standard';
    }

    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return 'N/A';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (hours > 0) {
            return `${hours}h ${minutes}min`;
        } else {
            return `${minutes}min`;
        }
    }

    function formatDistance(meters) {
        if (!meters || isNaN(meters)) return 'N/A';
        
        if (meters < 1000) {
            return `${Math.round(meters)}m`;
        } else {
            return `${(meters / 1000).toFixed(1)}km`;
        }
    }

    function formatScore(score) {
        if (!score || isNaN(score)) return 'N/A';
        return `${score.toFixed(1)}/10`;
    }

    function getScoreClass(score) {
        if (!score || isNaN(score)) return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
        
        if (score >= 8.5) return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
        if (score >= 7.0) return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
        if (score >= 5.5) return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
        if (score >= 3.0) return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';
        return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
    }
    
    function getTrafficClass(status) {
        switch(status?.toLowerCase()) {
            case 'free': return 'bg-green-500';
            case 'light': return 'bg-yellow-500';
            case 'moderate': return 'bg-orange-500';
            case 'heavy': return 'bg-red-500';
            case 'severe': return 'bg-red-700';
            default: return 'bg-gray-500';
        }
    }

    function getTrafficDescription(trafficAnalysis) {
        if (!trafficAnalysis) return 'Trafic inconnu';
        
        const status = trafficAnalysis.status || trafficAnalysis.level || 'unknown';
        const descriptions = {
            'free': 'Circulation fluide',
            'light': 'Trafic l√©ger',
            'moderate': 'Trafic mod√©r√©',
            'heavy': 'Trafic dense',
            'severe': 'Circulation difficile',
            'unknown': 'Trafic inconnu'
        };
        
        return descriptions[status.toLowerCase()] || 'Trafic inconnu';
    }

    function selectRoute(index) {
        const previousIndex = selectedRouteIndex;
        selectedRouteIndex = index;
        
        // Update UI
        document.querySelectorAll('.route-card').forEach((card, i) => {
            card.classList.toggle('selected', i === index);
            if (i === index) {
                card.classList.add('ring-2', 'ring-primary-500');
            } else {
                card.classList.remove('ring-2', 'ring-primary-500');
            }
        });

        // ‚úÖ Update map if available
        if (mapManager && mapManager.isInitialized) {
            mapManager.selectRoute(index);
        }

        console.log('Route s√©lectionn√©e:', index, currentRoutes[index]);
        
        // Track analytics
        if (window.trackEvent) {
            window.trackEvent('route_selected', { 
                index, 
                previousIndex,
                route_id: currentRoutes[index]?.id 
            });
        }
    }

    function displayRoutesOnMap(routes) {
        if (!mapManager || !mapManager.isInitialized) {
            console.warn('Map not initialized');
            return;
        }

        try {
            mapManager.displayRoutes(routes);
            console.log('Routes affich√©es sur la carte HERE Maps');
        } catch (error) {
            console.error('Erreur affichage routes sur carte:', error);
        }
    }

    function highlightRouteOnMap(route, index) {
        if (!mapManager || !mapManager.isInitialized) return;
        
        mapManager.selectRoute(index);
    }

    function toggleTrafficLayer() {
        if (!mapManager || !mapManager.isInitialized) {
            showAlert('Carte non initialis√©e', 'error');
            return;
        }

        try {
            const trafficEnabled = mapManager.toggleTrafficLayer();
            const button = document.getElementById('traffic-toggle');
            
            if (trafficEnabled) {
                button.classList.add('bg-blue-600', 'text-white');
                button.classList.remove('bg-gray-200', 'text-gray-700');
                showAlert('Couche trafic activ√©e', 'success');
            } else {
                button.classList.remove('bg-blue-600', 'text-white');
                button.classList.add('bg-gray-200', 'text-gray-700');
                showAlert('Couche trafic d√©sactiv√©e', 'info');
            }
        } catch (error) {
            console.error('Erreur toggle traffic:', error);
            showAlert('Erreur lors du basculement du trafic', 'error');
        }
    }

    function centerMap() {
        if (!mapManager || !mapManager.isInitialized) {
            showAlert('Carte non initialis√©e', 'error');
            return;
        }

        try {
            if (currentRoutes && currentRoutes.length > 0) {
                const center = calculateMapCenter(currentRoutes);
                mapManager.centerMap(center, 12);
                showAlert('Carte centr√©e', 'success');
            }
        } catch (error) {
            console.error('Erreur centrage carte:', error);
        }
    }

    async function toggleFullscreen() {
        if (!mapManager || !mapManager.isInitialized) {
            showAlert('Carte non initialis√©e', 'error');
            return;
        }

        try {
            const isFullscreen = await mapManager.toggleFullscreen();
            const button = document.querySelector('button[onclick="toggleFullscreen()"]');
            
            if (isFullscreen) {
                button.innerHTML = '<i class="fas fa-compress mr-1"></i> Quitter';
            } else {
                button.innerHTML = '<i class="fas fa-expand mr-1"></i> Plein √©cran';
            }
        } catch (error) {
            console.error('Erreur fullscreen:', error);
            showAlert('Erreur plein √©cran', 'error');
        }
    }

    function showMapError() {
        const mapContainer = document.getElementById('map-container');
        if (mapContainer) {
            mapContainer.innerHTML = `
                <div class="flex items-center justify-center h-full bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <div class="text-center p-6">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                            Erreur de carte
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">
                            Impossible de charger la carte interactive
                        </p>
                        <button onclick="initializeHereMap()" class="btn-primary">
                            <i class="fas fa-redo mr-2"></i>
                            R√©essayer
                        </button>
                    </div>
                </div>
            `;
        }
    }

    function startNavigation(routeIndex) {
        const route = currentRoutes[routeIndex];
        if (!route) return;

        // Sauvegarder la route s√©lectionn√©e
        sessionStorage.setItem('selectedRoute', JSON.stringify(route));
        sessionStorage.setItem('navigationRoute', JSON.stringify({
            route: route,
            searchData: searchResultsData
        }));
        
        showAlert('üöÄ Navigation d√©marr√©e !', 'success');
        
        // Rediriger vers la page de navigation
        window.location.href = '/navigation';
    }

    function showRouteDetails(routeIndex) {
        const route = currentRoutes[routeIndex];
        if (!route) return;

        const modal = document.getElementById('route-details-modal');
        const content = document.getElementById('route-details-content');

        content.innerHTML = generateRouteDetailsHTML(route);
        modal.classList.remove('hidden');
        
        // Focus sur le modal pour l'accessibilit√©
        modal.focus();
    }

    function closeRouteDetails() {
        document.getElementById('route-details-modal').classList.add('hidden');
    }

    function generateRouteDetailsHTML(route) {
        const summary = route.summary || route.original_data?.summary || {};
        
        return `
            <div class="space-y-6">
                <!-- Overview -->
                <div>
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-info-circle mr-2"></i>Aper√ßu de la route
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Dur√©e</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatDuration(summary.duration)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Distance</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatDistance(summary.length)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Score d'optimisation</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${formatScore(route.optimization_score)}
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300">Conditions trafic</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${getTrafficDescription(route.traffic_analysis)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Traffic Analysis -->
                ${route.traffic_analysis ? `
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">
                            <i class="fas fa-road mr-2"></i>Analyse du trafic
                        </h4>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <div class="w-4 h-4 rounded-full ${getTrafficClass(route.traffic_analysis.status || route.traffic_analysis.level)} mr-3"></div>
                                <span class="font-medium text-gray-900 dark:text-white">
                                    ${getTrafficDescription(route.traffic_analysis)}
                                </span>
                            </div>
                            ${route.traffic_analysis.ratio ? `
                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                    Fluidit√© : ${route.traffic_analysis.ratio.toFixed(1)}x le temps normal
                                </p>
                            ` : ''}
                            ${route.traffic_analysis.delay_seconds ? `
                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                    D√©lai estim√© : +${formatDuration(route.traffic_analysis.delay_seconds)}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}

                <!-- Route Specifics -->
                <div>
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-route mr-2"></i>Caract√©ristiques
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Type d'itin√©raire</span>
                            <span class="font-medium">${getRouteTypeLabel(route)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Score d'optimisation</span>
                            <span class="font-medium">${formatScore(route.optimization_score)}</span>
                        </div>
                        ${route.time_saved ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Temps √©conomis√©</span>
                                <span class="font-medium text-green-600">${formatDuration(route.time_saved)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="startNavigation(${selectedRouteIndex})" class="btn-primary flex-1">
                        <i class="fas fa-play mr-2"></i>
                        D√©marrer la navigation
                    </button>
                    <button onclick="saveRoute(${selectedRouteIndex})" class="btn-secondary">
                        <i class="fas fa-star mr-2"></i>
                        Sauvegarder
                    </button>
                    <button onclick="shareRoute(${selectedRouteIndex})" class="btn-secondary">
                        <i class="fas fa-share mr-2"></i>
                        Partager
                    </button>
                </div>
            </div>
        `;
    }

    function modifySearch() {
        // Retourner √† la page de recherche
        window.location.href = '{{ url_for("main.search") }}';
    }

    function refreshResults() {
        const refreshBtn = document.getElementById('refresh-btn');
        const originalContent = refreshBtn.innerHTML;
        
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Actualisation...';
        refreshBtn.disabled = true;

        setTimeout(() => {
            refreshBtn.innerHTML = originalContent;
            refreshBtn.disabled = false;
            showAlert('R√©sultats actualis√©s', 'success');
        }, 1000);
    }

    function showLoading() {
        document.getElementById('routes-loading').classList.remove('hidden');
        document.getElementById('routes-container').classList.add('hidden');
        document.getElementById('no-results').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
    }

    function hideLoading() {
        document.getElementById('routes-loading').classList.add('hidden');
    }

    function showNoResults() {
        hideLoading();
        document.getElementById('no-results').classList.remove('hidden');
    }

    function showError(message) {
        hideLoading();
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-state').classList.remove('hidden');
    }

    async function saveRoute(routeIndex) {
        const userElement = document.querySelector('[data-user-authenticated]');
        const isAuthenticated = userElement?.dataset.userAuthenticated === 'true';
        
        if (!isAuthenticated) {
            showAlert('Veuillez vous connecter pour sauvegarder des itin√©raires', 'warning');
            return;
        }

        const route = currentRoutes[routeIndex];
        const routeName = prompt('Nom de l\'itin√©raire :', 
            `Route optimale - ${formatDuration(route.summary?.duration || 0)}`);
        
        if (!routeName) return;

        try {
            const originCoords = route.origin_coords || {};
            const destCoords = route.destination_coords || {};
            
            const response = await fetch('/api/saved-routes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: routeName,
                    origin_address: originCoords.address || 'Point de d√©part',
                    origin_lat: originCoords.lat || 0,
                    origin_lng: originCoords.lng || 0,
                    destination_address: destCoords.address || 'Point d\'arriv√©e',
                    destination_lat: destCoords.lat || 0,
                    destination_lng: destCoords.lng || 0
                })
            });

            const data = await response.json();
            if (data.success) {
                showAlert('‚úÖ Itin√©raire sauvegard√© avec succ√®s', 'success');
            } else {
                showAlert('‚ùå Erreur lors de la sauvegarde', 'error');
            }
        } catch (error) {
            console.error('Save error:', error);
            showAlert('‚ùå Erreur lors de la sauvegarde', 'error');
        }
    }

    async function shareRoute(routeIndex) {
        const route = currentRoutes[routeIndex];
        if (!route) return;

        const shareData = {
            title: 'Itin√©raire SmartRoute',
            text: `D√©couvrez cet itin√©raire optimis√© : ${formatDuration(route.summary?.duration)} pour ${formatDistance(route.summary?.length)}`,
            url: window.location.href
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
                showAlert('Itin√©raire partag√©', 'success');
            } else {
                // Fallback : copier le lien
                await navigator.clipboard.writeText(window.location.href);
                showAlert('Lien copi√© dans le presse-papiers', 'success');
            }
        } catch (error) {
            console.error('Share error:', error);
            showAlert('Erreur lors du partage', 'error');
        }
    }

    document.addEventListener('keydown', function(e) {
        // Fermer les modals avec √âchap
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal-overlay:not(.hidden)');
            modals.forEach(modal => modal.classList.add('hidden'));
        }
        
        // Navigation entre les routes avec les fl√®ches
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            const currentIndex = selectedRouteIndex;
            let newIndex;
            
            if (e.key === 'ArrowUp') {
                newIndex = currentIndex > 0 ? currentIndex - 1 : currentRoutes.length - 1;
            } else {
                newIndex = currentIndex < currentRoutes.length - 1 ? currentIndex + 1 : 0;
            }
            
            selectRoute(newIndex);
            e.preventDefault();
        }
    });
</script>
{% endblock %}